# éš¨æ©Ÿæ£®æ— (Random forest)

## ä»Šæ—¥å­¸ç¿’ç›®æ¨™
- éš¨æ©Ÿæ£®æ—ä»‹ç´¹
    - éš¨æ©Ÿæ£®æ—çš„æ¨¹æ˜¯å¦‚ä½•ç”Ÿæˆï¼Ÿéš¨æ©Ÿæ£®æ—çš„å„ªé»ï¼Ÿ
    - éš¨æ©Ÿæ£®æ—å¦‚ä½•è™•ç†åˆ†é¡å•é¡Œï¼Ÿ
    - éš¨æ©Ÿæ£®æ—å¦‚ä½•è™•ç†è¿´æ­¸å•é¡Œï¼Ÿ
- å¯¦ä½œéš¨æ©Ÿæ£®æ—åˆ†é¡å™¨
    - æ¯”è¼ƒéš¨æ©Ÿæ£®æ—èˆ‡æ±ºç­–æ¨¹å…©è€…å·®åˆ¥ã€‚


## éš¨æ©Ÿæ£®æ—
éš¨æ©Ÿæ£®æ—å…¶å¯¦å°±æ˜¯é€²éšç‰ˆçš„æ±ºç­–æ¨¹ï¼Œæ‰€è¬‚çš„æ£®æ—å°±æ˜¯ç”±å¾ˆå¤šæ£µæ±ºç­–æ¨¹æ‰€çµ„æˆã€‚éš¨æ©Ÿæ£®æ—æ˜¯ä½¿ç”¨ Bagging åŠ ä¸Šéš¨æ©Ÿç‰¹å¾µæ¡æ¨£çš„æ–¹æ³•æ‰€ç”¢ç”Ÿå‡ºä¾†çš„æ•´é«”å­¸ç¿’æ¼”ç®—æ³•ã€‚é‚„è¨˜å¾—åœ¨å‰å¹¾å¤©çš„æ±ºç­–æ¨¹æ¼”ç®—æ³•ä¸­ï¼Œç•¶æ¨¡å‹çš„æ¨¹æœ€å¤§æ·±åº¦è¨­å®šå¤ªå¤§çš„è©±å®¹æ˜“è®“æ¨¡å‹éæ“¬åˆã€‚å› æ­¤éš¨æ©Ÿæ£®æ—è—‰ç”±å¤šæ£µä¸åŒæ¨¹çš„æ¦‚å¿µæ‰€çµ„æˆï¼Œè®“çµæœæ¯”è¼ƒä¸å®¹æ˜“éåº¦æ“¬åˆï¼Œä¸¦ä½¿å¾—é æ¸¬èƒ½åŠ›æ›´æå‡ã€‚

![](./image/img14-1.png)

## éš¨æ©Ÿæ£®æ—çš„ç”Ÿæˆæ–¹æ³•
é¦–å…ˆå¾è¨“ç·´é›†ä¸­æŠ½å– nâ€™ ç­†è³‡æ–™å‡ºä¾†ï¼Œç„¶è€Œé€™ nâ€™ ç­†è³‡æ–™æ˜¯å¯ä»¥è¢«é‡è¤‡æŠ½å–çš„ã€‚å‡è¨­æˆ‘å€‘æœ‰ä¸€åƒç­†è³‡æ–™æˆ‘å€‘è¦å¾ä¸­æŠ½å– 100 ç­†è³‡æ–™å‡ºä¾†ï¼Œé€™ 100 ç­†è³‡æ–™è£¡é¢å¯èƒ½æœƒæœ‰é‡è¤‡çš„æ•¸æ“šã€‚æ¥è‘—ç¬¬äºŒæ­¥å¾é€™äº›æŠ½å–å‡ºä¾†çš„è³‡æ–™ä¸­æŒ‘é¸ k å€‹ç‰¹å¾µç•¶ä½œæ±ºç­–å› å­çš„å¾Œé¸ï¼Œå› æ­¤æ¯ä¸€æ£µæ¨¹åªèƒ½çœ‹è¦‹éƒ¨åˆ†çš„ç‰¹å¾µã€‚ç¬¬ä¸‰æ­¥é‡è¤‡ä»¥ä¸Šæ­¥é©Ÿ m æ¬¡ä¸¦ç”¢ç”Ÿ m æ£µæ±ºç­–æ¨¹ã€‚é€é Bootstrap æ­¥é©Ÿé‡è¤‡ m æ¬¡ï¼Œåšå®Œä¹‹å¾Œæˆ‘å€‘æœƒæœ‰ m çµ„çš„è¨“ç·´è³‡æ–™ï¼Œæ¯ä¸€çµ„è¨“ç·´è³‡æ–™å…§éƒ½æœ‰ nâ€™ ç­†è³‡æ–™ã€‚æœ€å¾Œå†é€éæ¯æ£µæ¨¹çš„æ±ºç­–ä¸¦æ¡å¤šæ•¸æ±ºæŠ•ç¥¨çš„æ–¹å¼ï¼Œæ±ºå®šæœ€çµ‚é æ¸¬çš„é¡åˆ¥ã€‚å› ç‚ºéš¨æ©Ÿæ£®æ—æ¯ä¸€æ£µæ¨¹çš„ç‰¹å¾µæ•¸é‡å¯èƒ½éƒ½ä¸åŒï¼Œæ‰€ä»¥æœ€å¾Œæ±ºç­–å‡ºä¾†çš„çµæœéƒ½æœƒä¸ä¸€æ¨£ã€‚æœ€å¾Œå†æ ¹æ“šä»»å‹™çš„ä¸åŒä¾†åšè¿´æ­¸æˆ–æ˜¯åˆ†é¡çš„å•é¡Œï¼Œå¦‚æœæ˜¯è¿´æ­¸å•é¡Œæˆ‘å€‘å°±å°‡é€™äº›æ±ºç­–æ•¸çš„è¼¸å‡ºåšå¹³å‡å¾—åˆ°æœ€å¾Œç­”æ¡ˆï¼Œè‹¥æ˜¯åˆ†é¡å•é¡Œæˆ‘å€‘å‰‡ç”¨æŠ•æ¨™æ¡å¤šæ•¸æ±ºçš„æ–¹å¼ä¾†æ•´åˆæ‰€æœ‰æ¨¹é æ¸¬çš„çµæœã€‚

1. å¾è¨“ç·´é›†ä¸­æŠ½å– nâ€™ ç­†è³‡æ–™å‡ºä¾†
2. nâ€™ ç­†è³‡æ–™éš¨æ©ŸæŒ‘é¸ k å€‹ç‰¹å¾µåšæ¨£æœ¬
3. é‡è¤‡ m æ¬¡ï¼Œç”¢ç”Ÿ m æ£µæ±ºç­–æ¨¹
4. åˆ†é¡: å¤šæ•¸æŠ•ç¥¨æ©Ÿåˆ¶é€²è¡Œé æ¸¬ã€è¿´æ­¸: å¹³å‡æ©Ÿåˆ¶é€²è¡Œé æ¸¬

![](./image/img14-2.png)

## éš¨æ©Ÿæ£®æ—ä¸­çš„éš¨æ©Ÿï¼Ÿ
éš¨æ©Ÿæ£®æ—ä¸­çš„éš¨æ©Ÿæœ‰å…©ç¨®æ–¹é¢å¯ä»¥è§£é‡‹ã€‚é¦–å…ˆç¬¬ä¸€å€‹æ˜¯éš¨æ©Ÿå–æ¨£ï¼Œåœ¨æ¨¡å‹è¨“ç·´çš„éç¨‹ä¸­æ¯æ£µæ¨¹çš„ç”Ÿæˆéƒ½æœƒå…ˆå¾è¨“ç·´é›†ä¸­éš¨æ©ŸæŠ½å– nâ€™ ç­†è³‡æ–™å‡ºä¾†ï¼Œè€Œé€™ nâ€™ ç­†è³‡æ–™æ˜¯å¯ä»¥è¢«é‡è¤‡æŠ½å–çš„ã€‚æ­¤æŠ½å–è³‡æ–™çš„æ–¹å¼åˆç¨±ç‚º Bootstrapï¼Œå®ƒæ˜¯ä¸€ç¨®åœ¨çµ±è¨ˆå­¸ä¸Šå¸¸ç”¨çš„è³‡æ–™ä¼°è¨ˆæ–¹æ³•ã€‚ç¬¬äºŒå€‹è§£é‡‹éš¨æ©Ÿçš„ç†ç”±æ˜¯åœ¨éš¨æ©Ÿæ£®æ—ä¸­æ¯ä¸€æ£µæ¨¹éƒ½æ˜¯éš¨æ©Ÿçš„ç‰¹å¾µé¸å–ã€‚æ¯ä¸€æ£µæ¨¹éƒ½æ˜¯å¾ nâ€™ ç­†è³‡æ–™ä¸­éš¨æ©ŸæŒ‘é¸ k å€‹ç‰¹å¾µåšæ¨£æœ¬ã€‚

> åœ¨ sklearn ä¸­ï¼Œæœ€å¤šéš¨æ©Ÿé¸å– ğ‘™ğ‘œğ‘”<sub>2</sub>ğ‘ å€‹ç‰¹å¾µ

## éš¨æ©Ÿæ£®æ—çš„å„ªé»
- æ¯æ£µæ¨¹æœƒç”¨åˆ°å“ªäº›è¨“ç·´è³‡æ–™åŠç‰¹å¾µéƒ½æ˜¯ç”±éš¨æ©Ÿæ±ºå®š
- æ¡ç”¨å¤šå€‹æ±ºç­–æ¨¹çš„æŠ•ç¥¨æ©Ÿåˆ¶ä¾†æ”¹å–„æ±ºç­–æ¨¹
- èˆ‡æ±ºç­–æ¨¹ç›¸æ¯”ï¼Œä¸å®¹æ˜“éåº¦æ“¬åˆ
- éš¨æ©Ÿæ£®æ—æ¯ä¸€æ£µæ¨¹éƒ½æ˜¯ç¨ç«‹çš„
- è¨“ç·´æˆ–æ˜¯é æ¸¬çš„éšæ®µæ¯ä¸€æ£µæ¨¹éƒ½èƒ½å¹³è¡ŒåŒ–çš„é‹è¡Œ

## [ç¨‹å¼å¯¦ä½œ]
## éš¨æ©Ÿæ£®æ—(åˆ†é¡å™¨)

Parameters:
- n_estimators: æ£®æ—ä¸­æ¨¹æœ¨çš„æ•¸é‡ï¼Œé è¨­=100ã€‚
- max_features: åŠƒåˆ†æ™‚è€ƒæ…®çš„æœ€å¤§ç‰¹å¾µæ•¸ï¼Œé è¨­autoã€‚
- criterion: äº‚åº¦çš„è©•ä¼°æ¨™æº–ï¼Œgini/entropyã€‚é è¨­ç‚ºginiã€‚
- max_depth: æ¨¹çš„æœ€å¤§æ·±åº¦ã€‚
- splitter: ç‰¹å¾µåŠƒåˆ†é»é¸æ“‡æ¨™æº–ï¼Œbest/randomã€‚é è¨­ç‚ºbestã€‚
- random_state: äº‚æ•¸ç¨®å­ï¼Œç¢ºä¿æ¯æ¬¡è¨“ç·´çµæœéƒ½ä¸€æ¨£ï¼Œsplitter=random æ‰æœ‰ç”¨ã€‚
- min_samples_split: è‡³å°‘æœ‰å¤šå°‘è³‡æ–™æ‰èƒ½å†åˆ†
- min_samples_leaf: åˆ†å®Œè‡³å°‘æœ‰å¤šå°‘è³‡æ–™æ‰èƒ½åˆ†

Attributes:
- feature_importances_: æŸ¥è©¢æ¨¡å‹ç‰¹å¾µçš„é‡è¦ç¨‹åº¦ã€‚

Methods:
- fit: æ”¾å…¥Xã€yé€²è¡Œæ¨¡å‹æ“¬åˆã€‚
- predict: é æ¸¬ä¸¦å›å‚³é æ¸¬é¡åˆ¥ã€‚
- score: é æ¸¬æˆåŠŸçš„æ¯”ä¾‹ã€‚
- predict_proba: é æ¸¬æ¯å€‹é¡åˆ¥çš„æ©Ÿç‡å€¼ã€‚
- get_depth: å–å¾—æ¨¹çš„æ·±åº¦ã€‚

```py
from sklearn.ensemble import RandomForestClassifier

# å»ºç«‹ Random Forest Classifier æ¨¡å‹
randomForestModel = RandomForestClassifier(n_estimators=100, criterion = 'gini')
# ä½¿ç”¨è¨“ç·´è³‡æ–™è¨“ç·´æ¨¡å‹
randomForestModel.fit(X_train, y_train)
# ä½¿ç”¨è¨“ç·´è³‡æ–™é æ¸¬åˆ†é¡
predicted = randomForestModel.predict(X_train)
```

### ä½¿ç”¨Scoreè©•ä¼°æ¨¡å‹
æˆ‘å€‘å¯ä»¥ç›´æ¥å‘¼å« `score()` ç›´æ¥è¨ˆç®—æ¨¡å‹é æ¸¬çš„æº–ç¢ºç‡ã€‚

```py
# é æ¸¬æˆåŠŸçš„æ¯”ä¾‹
print('è¨“ç·´é›†: ',knnModel.score(X_train,y_train))
print('æ¸¬è©¦é›†: ',knnModel.score(X_test,y_test))
```

è¼¸å‡ºçµæœï¼š
```
è¨“ç·´é›†:  1.0
æ¸¬è©¦é›†:  0.8888888888888888
```

æˆ‘å€‘å¯ä»¥æŸ¥çœ‹è¨“ç·´å¥½çš„æ¨¡å‹åœ¨æ¸¬è©¦é›†ä¸Šçš„é æ¸¬èƒ½åŠ›ï¼Œä¸‹åœ–ä¸­å·¦é‚Šçš„æ˜¯æ¸¬è©¦é›†çš„çœŸå¯¦åˆ†é¡ï¼Œå³é‚Šçš„æ˜¯æ¨¡å‹é æ¸¬çš„åˆ†é¡çµæœã€‚ç”±æ–¼è¨“ç·´è³‡æ–™ç­†æ•¸ä¸å¤šï¼Œå› æ­¤æ¨¡å‹è¨“ç·´å®¹æ˜“éåº¦æ“¬åˆè¨“ç·´é›†çš„åˆ†å¸ƒã€‚æœ€çµ‚åœ¨æ¸¬è©¦åŠé æ¸¬çš„è¡¨ç¾ä¸Šåƒ…æœ‰ 0.88 çš„æº–ç¢ºç‡ã€‚

![](./image/img14-3.png)

### ç‰¹å¾µé‡è¦ç¨‹åº¦
åªè¦æ˜¯æ±ºç­–æ¨¹ç³»åˆ—æ¼”ç®—æ³•ï¼Œä¸ç®¡æ˜¯åˆ†é¡å™¨æˆ–æ˜¯è¿´æ­¸å™¨éƒ½èƒ½é€é `feature_importances_` ä¾†æª¢è¦–æ¨¡å‹é æ¸¬å°æ–¼ç‰¹å¾µçš„é‡è¦ç¨‹åº¦ã€‚

```py
print('ç‰¹å¾µé‡è¦ç¨‹åº¦: ',randomForestModel.feature_importances_)
```

è¼¸å‡ºçµæœï¼š
```
ç‰¹å¾µé‡è¦ç¨‹åº¦:  [0.09864249 0.01363871 0.44211602 0.44560278]
```

## éš¨æ©Ÿæ£®æ—(è¿´æ­¸å™¨)

Parameters:
- n_estimators: æ£®æ—ä¸­æ¨¹æœ¨çš„æ•¸é‡ï¼Œé è¨­=100ã€‚
- max_features: åŠƒåˆ†æ™‚è€ƒæ…®çš„æœ€å¤§ç‰¹å¾µæ•¸ï¼Œé è¨­autoã€‚
- criterion: è©•ä¼°åˆ‡å‰²é»æŒ‡æ¨™ï¼Œmse/maeã€‚
- max_depth: æ¨¹çš„æœ€å¤§æ·±åº¦ã€‚
- splitter: ç‰¹å¾µåŠƒåˆ†é»é¸æ“‡æ¨™æº–ï¼Œbest/randomã€‚é è¨­ç‚ºbestã€‚
- random_state: äº‚æ•¸ç¨®å­ï¼Œç¢ºä¿æ¯æ¬¡è¨“ç·´çµæœéƒ½ä¸€æ¨£ï¼Œsplitter=random æ‰æœ‰ç”¨ã€‚
- min_samples_split: è‡³å°‘æœ‰å¤šå°‘è³‡æ–™æ‰èƒ½å†åˆ†
- min_samples_leaf: åˆ†å®Œè‡³å°‘æœ‰å¤šå°‘è³‡æ–™æ‰èƒ½åˆ†

Attributes:
- feature_importances_: æŸ¥è©¢æ¨¡å‹ç‰¹å¾µçš„é‡è¦ç¨‹åº¦ã€‚

Methods:
- fit: æ”¾å…¥Xã€yé€²è¡Œæ¨¡å‹æ“¬åˆã€‚
- predict: é æ¸¬ä¸¦å›å‚³é æ¸¬ã€‚
- score: é æ¸¬æˆåŠŸçš„æ¯”ä¾‹ã€‚
- get_depth: å–å¾—æ¨¹çš„æ·±åº¦ã€‚

```py
from sklearn.ensemble import RandomForestRegressor

# å»ºç«‹RandomForestRegressoræ¨¡å‹
randomForestModel = RandomForestRegressor(n_estimators=100, criterion = 'mse')
# ä½¿ç”¨è¨“ç·´è³‡æ–™è¨“ç·´æ¨¡å‹
randomForestModel.fit(x, y)
# ä½¿ç”¨è¨“ç·´è³‡æ–™é æ¸¬
predicted=randomForestModel.predict(x)
```

![](./image/img14-4.png)

æœ¬ç³»åˆ—æ•™å­¸å…§å®¹åŠç¯„ä¾‹ç¨‹å¼éƒ½å¯ä»¥å¾æˆ‘çš„ [GitHub](https://github.com/andy6804tw/2021-13th-ironman) å–å¾—ï¼